<?php
// $Id$

/**
 * Test the organic groups API functions.
 */
class OgApiUnitTest extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Organic groups API',
      'description' => 'Test the organic groups API.',
      'group' => 'Organic groups',
    );
  }

  function setUp() {
    parent::setUp('og');
    $web_user = $this->drupalCreateUser(array('create article content', 'create page content'));
    $this->drupalLogin($web_user);
    $this->uid = $web_user->uid;
    
    // Create four nodes a user, and associate them to a group.
    $group = $this->drupalCreateNode(array('type' => 'article'));
    $this->group = $group->nid;
    
    $nodes = array();
    $nodes[] = $this->drupalCreateNode(array('type' => 'article'));
    $nodes[] = $this->drupalCreateNode(array('type' => 'article'));
    $nodes[] = $this->drupalCreateNode(array('type' => 'article'));
    $nodes[] = $this->drupalCreateNode(array('type' => 'page'));
        
    foreach ($nodes as $node) {
      og_set_association($group->nid, $node->nid, 'node');
      // Add the node IDs so we can perform actions with them.
      $this->nodes[] = $node->nid;        
    }
            
    // Associate the user.
    og_set_association($group->nid, $this->uid, 'user');    
  }

  
  /**
   * Test organic groups API.
   */
  function testOgApi() {   
    $this->groupAssociation();   
     
  }
  
  function groupAssociation() {
    $association_get = og_get_association_by_group($this->group);
    
    $this->assertTrue(count($association_get['node']) == 4, t('All associated nodes were found.'));
    $this->assertTrue(count($association_get['user']) == 1, t('Associated user was found.'));
    
    // Move some content to a new group.
    $new_group = $this->drupalCreateNode(array('type' => 'article'));
    og_move_group_association($this->group, $new_group->nid, array('node' => array($this->nodes[1], $this->nodes[2], $this->nodes[3])));
    
    $association_get = og_get_association_by_group($this->group);
    $this->assertTrue(count($association_get['node']) == 1, t('Some content moved from old group.'));
    
    $association_get = og_get_association_by_group($new_group->nid);
    $this->assertTrue(count($association_get['node']) == 3, t('Some content moved to new group.'));
    
    // Move all the rest of the content to a new group.
     og_move_group_association($this->group, $new_group->nid);
    $association_get = og_get_association_by_group($this->group);
    $this->assertTrue(empty($association_get), t('All content moved from old group.'));
     
    $association_get = og_get_association_by_group($new_group->nid);
    $this->assertTrue(count($association_get['node']) == 4 && count($association_get['user']) == 1, t('All content moved to new group.'));     
  } 
}